$(function () {

  var endTime = ${chart.endTime},
    startTime = ${chart.startTime},
    maximized = false,
    maximizedStream,
    height = getHeight(),
    width = $("#theChart").width(),
    chart;

  $(window).resize(function () {
	var height = getHeight();
    console.log('fit new div container size, width='+$("#theChart").width()+' height='+height+' windowH='+$(window).height());
    var width = $("#theChart").width();
    if(chart != null)
        chart.setSize(width, height, false);
  });

  $.ajaxSetup({
    username: '${username}',
    password: '${password}'
  });

  Highcharts.setOptions({
    credits: {
      enabled: false
    },
    global: {
      useUTC: false
    }
  });

  function crisp(arr) {
    var i = arr.length;
    while (i--) {
      if (typeof arr[i] === 'number') {
        arr[i] = Math.round(arr[i]) - 0.5;
      }
    }
    return arr;
  }

  function getHeight() {
	var override = ${height};
	if(override > 0)
		return override;
	var windowHeight = $(window).height();
	var height = windowHeight;
	if(height < 300)
		height = 300;
	return height;
  }
  
  function collapseData(data, columnName) {
    var collapsedData = [];
    $.each(data.data, function (index, value) {
      collapsedData.push([value.${chart.timeColumn}, (value == "NaN") ? null : value[columnName] ]);
    });
    return collapsedData;
  }

  function expandData(data) {
    var expandedData = {};
    expandedData.data = [];
    expandedData.error = [];
    $.each(data, function (index, value) {
      expandedData.data.push({
        "time": value[0],
          "value": value[1] * 1000
      });
    });
    return expandedData;
  }
  window.collapseData = collapseData;
  window.expandData = expandData;

  function addChart(reverseAxis, singleStream, title) {
    reverseAxis = typeof reverseAxis !== 'undefined' ? reverseAxis : false;
    singleStream = typeof singleStream !== 'undefined' ? singleStream : false;
    title = typeof title !== 'undefined' ? title : false;

    var url = '${chart.url}';
    if(url.indexOf('?') > 0) {
    	url = url + '&callback=?';
    } else
        url = url + '?callback=?';
    
    console.log('url='+url);
    
    $('#theChart').append($('<div class="chart" />').attr('id', 'mychart'));
    $.getJSON(url, function (data) {
        
    	console.log('json callback being called with data');
        var msg = "No data available in the specified time period."
        if(data.data.length != 0) {
            msg = "Last value was "+data.data[data.data.length-1].${chart.series1.name}+" at "+new Date(data.data[data.data.length-1].${chart.timeColumn}).toUTCString()
        }

      console.log('window2222 height:'+$(window).height());
      chart = new Highcharts.Chart({
          chart: {
              renderTo: ${divName},
              height: getHeight(),
              zoomType: ""
          },
          title: {
              text: (title!==false ? title : '${chart.title}') 
          },
          subtitle: {
                text: msg
          },
          xAxis: {
              ordinal: false
          },
          yAxis: [
#{list chart.axisList, as:'axis'}#{chart_yaxis axis:axis/}
#{if axis_index < chart.axisList.size()},#{/if}
#{/list}
          ],
          tooltip: {
              shared: true
          },
          legend: {
              align: 'center',
              enabled: true,
              floating: true,
              verticalAlign: 'top',
              y: 40,
              symbolWidth: 30
          },
          series: [
  #{list chart.seriesList, as:'series'}#{chart_series series:series/}
  #{if series_index < chart.seriesList.size()},#{/if}
  #{/list}
          ]
        });

      
    });
  }

  $(document).bind('keyup', 'esc', function () {
    if (maximized) {
      maximized = false;
      $('.overlay').toggleClass('overlay');
    }
  });

  addChart(false, true);
  console.log('addChart called, waiting on json data to come back');
})