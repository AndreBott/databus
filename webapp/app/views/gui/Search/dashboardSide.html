#{extends '_index.html' /}
#{set title:'Dashboard' /}
#{set tab:'dashboard' /}

<script type="text/javascript">
	var _charts_enabled = '${charts_enabled}';
	var _charts_library = '${charts_library}';
	
	%{
		showDashboard = false;
		if(dashboard_enabled.equals("true")) {
			showDashboard = true;
		}
	}%
	var _dashboard_enabled = '${showDashboard}';
	var _option_enabled = '${dashboard_chart_count}';
	
	var chart_1 = '${user_chart_1}';
	var chart_1_type = '${user_chart_1_type}';
	var chart_1_uri = '${user_chart_1_uri}';
	var chart_2 = '${user_chart_2}';
	var chart_2_type = '${user_chart_2_type}';
	var chart_2_uri = '${user_chart_2_uri}';
	var chart_3 = '${user_chart_3}';
	var chart_3_type = '${user_chart_3_type}';
	var chart_3_uri = '${user_chart_3_uri}';
	var chart_4 = '${user_chart_4}';
	var chart_4_type = '${user_chart_4_type}';
	var chart_4_uri = '${user_chart_4_uri}';
	
	var userCharts = [];
	
	#{list userCharts, as:'chart'}										
		var userChart = {};
		userChart.chartName = "${chart.chartName}";
		userChart.chartType = "${chart.chartType}";
		userChart.url = "${chart.getTrueChartURI()}";
		
		userCharts.push(userChart);									
	#{/list}
</script>

<!-- Highcarts Remote Load -->
<!-- IMPORTANT                                                                      -->
<!--    The HTTPS links work, and as far as I can tell do point to a server owned                   -->
<!--    by Highcharts, but they let their SSL certificate expire so browsers HATE                   -->
<!--    going there.                                                                    -->
<!--                                                                                -->
<!-- <script src="https://code.highcharts.com/highcharts.js" type="text/javascript"></script> -->
<!-- <script src="https://code.highcharts.com/stock/highstock.js" type="text/javascript"></script> -->
<!-- <script src="https://code.highcharts.com/stock/modules/exporting.js" type="text/javascript"></script> -->
<script type="text/javascript" src="/public/includes/highcharts/highcharts.js"></script>

<!-- Our HighCharts code -->
<script src="/public/javascripts/charts.js" type="text/javascript"></script>
<link href="/public/stylesheets/charts.css" rel="stylesheet" type="text/css">

<script type="text/javascript" src="/public/includes/highcharts/highstock.js"></script>
<script type="text/javascript" src="/public/includes/highcharts/highcharts-more.js"></script>
<script type="text/javascript" src="/public/includes/highcharts/exporting.js"></script>

%{
   if(gov.nrel.util.Utility.isDemoMode()) {
}%
<div class="alert alert-info alert-block">
   Step 1. You are on the customizable dashboard page where you can define which charts show up for this user</br>
   Step 2. Next, please click on My Databus, then click on Databases
</div>
%{
    }
}%

        <div class="row-fluid">

        <div class="span3 dashboard_chart_list">
		<!-- Need to add a left nav bar now so we can choose between all the different charts -->
			<ul class="nav nav-list">            
				<li class="db_left_nav_item active"><a id="SUMMARY" class="db_left_nav_menu_item"><i class="icon-th "></i> Summary</a></li> 
				<li class="divider"></li>
			</ul>
			<ul class="nav nav-list dashboard_chart_menu"> 
				#{list userCharts, as:'chart'}
					<li class="db_left_nav_item"><a id="${chart_index}" class="db_left_nav_menu_item"><i class="icon-signal "></i> ${chart.chartName}</a></li>
				#{/list}
			</ul>
	   </div>
	   <div id="charts_alert" class="span9 charts_alert" style="display: none;">
	   	 #{messages/charts_alert /}
	   </div>
	   <div class="span9" id="dashboard_chart_area" style="display: none;">
	  			<div id="single_chart" style="display: none;">
		    			#{dashboardCharts/singlechart /}
		    		</div>
		    		<div id="dual_chart" style="display: none;">
		    			#{dashboardCharts/dualchart /}
		    		</div>
		    		<div id="triple_chart" style="display: none;">
		    			#{dashboardCharts/threecharts /}
		    		</div>
		    		<div id="quadruple_chart" style="display: none;">
		    			#{dashboardCharts/fourcharts /}
		    		</div>
	   </div>
	   <div id="db_chart_area" class="span9" style="display: none;">
        </div>
    </div>
<script type="text/javascript">
	$(document).ready(function() {
		if(_charts_enabled === 'true') {
			if(_charts_library.indexOf('_licensed') >= 0) {
				$('#charts_alert').hide();
			} else {
				$('#charts_alert').show();
			}
		} else {
			$('#charts_alert').hide();
		}
	
		$('#SUMMARY').click();
	});
	
	$('li > a').click(function() {
		$( "li" ).each(function() {
			if($(this).hasClass("db_left_nav_item")) {
				$(this).removeClass("active");
			}
		});
		
		$(this).parent().addClass('active');
		
		/**
		 * Now run the chart
		 */		
		var selectedIndex = $(this).attr('id');
		
		if($.isNumeric(selectedIndex)) {
			var thisUserChart = userCharts[(selectedIndex - 1)];

			$('#db_chart_area').hide();
			$('#dashboard_chart_area').show();
			
			$('#single_chart').show();
			$('#dual_chart').hide();
			$('#triple_chart').hide();
			$('#quadruple_chart').hide();
			
			loadChart(thisUserChart.chartType, thisUserChart.url, 'chart_1_area', 600);
		}
	});

	$.ajaxSetup({
	    username: '${username}',
	    password: '${password}'
	  });
		
	$("#SUMMARY").click(function(){
		$('#db_chart_area').hide();
		$('#dashboard_chart_area').show();
		
		if(_dashboard_enabled === 'true') {
			if(_option_enabled === '1') {
				$('#dashboard_chart_area').show();
				$('#single_chart').show();
				$('#dual_chart').hide();
				$('#triple_chart').hide();
				$('#quadruple_chart').hide();
				
				// Now launch the chart
				if(chart_1 === 'BLANK') {					
					loadChart('BLANK', 'BLANK', 'chart_1_area', 600);
				} else {
					loadChart(chart_1_type, chart_1_uri, 'chart_1_area', 600);
				}
			} else if(_option_enabled === '2') {
				$('#dashboard_chart_area').show();
				$('#single_chart').hide();
				$('#dual_chart').show();
				$('#triple_chart').hide();
				$('#quadruple_chart').hide();
				
				// Now launch the charts
				if(chart_1 === 'BLANK') {
					loadChart('BLANK', 'BLANK', 'chart_2_area', 300);
				} else {
					loadChart(chart_1_type, chart_1_uri, 'chart_2_area', 300);
				}
				
				if(chart_2 === 'BLANK') {
					loadChart('BLANK', 'BLANK', 'chart_3_area', 300);
				} else {
					loadChart(chart_2_type, chart_2_uri, 'chart_3_area', 300);
				}
			} else if(_option_enabled === '3') {
				$('#dashboard_chart_area').show();
				$('#single_chart').hide();
				$('#dual_chart').hide();
				$('#triple_chart').show();
				$('#quadruple_chart').hide();
			
				// Now launch the charts
				if(chart_1 === 'BLANK') {
					loadChart('BLANK', 'BLANK', 'chart_4_area', 300);
				} else {
					loadChart(chart_1_type, chart_1_uri, 'chart_4_area', 300);
				}
				
				if(chart_2 === 'BLANK') {
					loadChart('BLANK', 'BLANK', 'chart_5_area', 300);
				} else {
					loadChart(chart_2_type, chart_2_uri, 'chart_5_area', 300);
				}
				
				if(chart_3 === 'BLANK') {
					loadChart('BLANK', 'BLANK', 'chart_6_area', 300);
				} else {
					loadChart(chart_3_type, chart_3_uri, 'chart_6_area', 300);
				}
			} else if(_option_enabled === '4') {
				$('#dashboard_chart_area').show();
				$('#single_chart').hide();
				$('#dual_chart').hide();
				$('#triple_chart').hide();
				$('#quadruple_chart').show();
				
				// Now launch the charts
				if(chart_1 === 'BLANK') {					
					loadChart('BLANK', 'BLANK', 'chart_7_area', 300);
				} else {
					loadChart(chart_1_type, chart_1_uri, 'chart_7_area', 300);
				}
				
				if(chart_2 === 'BLANK') {
					loadChart('BLANK', 'BLANK', 'chart_8_area', 300);
				} else {
					loadChart(chart_2_type, chart_2_uri, 'chart_8_area', 300);
				}
				
				if(chart_3 === 'BLANK') {
					loadChart('BLANK', 'BLANK', 'chart_9_area', 300);
				} else {
					loadChart(chart_3_type, chart_3_uri, 'chart_9_area', 300);
				}
				
				if(chart_4 === 'BLANK') {
					loadChart('BLANK', 'BLANK', 'chart_10_area', 300);
				} else {
					loadChart(chart_4_type, chart_4_uri, 'chart_10_area', 300);
				}			
			}				
		}
	});
	
	function loadChart(chartType, chartURI, chartDiv, chartHeight) {
		$(function () {
			var loadImageMarginTop = "20px";
			if(chartHeight == 600) {
				loadImageMarginTop = "150px";
			}
			$('#' + chartDiv).html('<img src="/public/images/chart_loading.gif" style="height: 300px; display: block; margin-left: auto; margin-right: auto; margin-top: ' + loadImageMarginTop + ';"/>');
			
			if(chartType === 'EMBEDDED_OBJECT') {
				var embeddedChartURL = chartURI + "?divname=" + chartDiv + "&height=" + chartHeight;
				embeddedChartURL = embeddedChartURL.replace("/charts/chart/", "/charts/jschart/"); 
				
				$.get(embeddedChartURL, function(embeddedChartRawData) {
					var embeddedChartData = new Function (embeddedChartRawData);
					embeddedChartData();
				});
			} else if(chartType === 'SCRIPT') {
				var chartURI_escaped = decodeURIComponent(chartURI).replace('&amp;', '&');
				
				var scriptChartURL = "@{gui.MyCharts.loadChartDiv()}?chart=" + chartURI_escaped + "&div=" + chartDiv;
				
				$.get(scriptChartURL, function(scriptChartRawData) {
					var scriptChartData = new Function (scriptChartRawData);
					scriptChartData();
				});
			} else if(chartType === 'BLANK') {
				/*
				var blankChartURL = "@{gui.MyCharts.loadChartDiv()}?chart=" + chartURI + "&div=" + chartDiv;
				
				$.get(blankChartURL, function(blankChartRawData) {
					var blankChartData = new Function (blankChartRawData);
					blankChartData();
				});
				*/
				$('#' + chartDiv).addClass('dashboardBlankChart');
				$('#' + chartDiv).html('<img src="/public/images/BlankDashboard.png" height="' + chartHeight + 'px" style="display: block; margin-left: auto; margin-right: auto; margin-top: 20px;"/>')
			}
		});
	}
	
	function fixedEncodeURIComponent (str) {
	  return encodeURIComponent(str).replace(/[!'()]/g, escape).replace(/\*/g, "%2A");
	}
</script>