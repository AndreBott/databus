
<!-- FOR DEBUG -->
<!--<html><body>
<script type="text/javascript" src="/public/javascripts/jquery-1.9.1.min.js"></script>
<link href="/public/bootstrap/css/bootstrap.css" rel="stylesheet" type="text/css">
<link href="/public/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
<script type="text/javascript" src="/public/bootstrap/js/bootstrap.js"></script>
<script type="text/javascript" src="/public/includes/highcharts/highstock.js"></script>-->
<!-- ********* -->

<script type="text/javascript" src="/public/javascripts/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="/public/includes/highcharts/highcharts.js"></script>
<script type="text/javascript" src="/public/includes/highcharts/highstock.js"></script>

<script type="text/javascript">
	var scriptCharts = [];
</script>

<div class="row-fluid">
	<div class="span12">
		<legend>
			Add Embedded Chart
		</legend>
		<p>
			An embedded chart is a chart that was created with the <a href="@{gui.MyCharts.createChart()}">Create Chart Wizard</a>.  The result
			is a URL which contains all of the information for displaying the chart.
		</p>
		#{form @postSaveEmbeddedChartSettings(), id:'saveembeddedchartsettings'}
		<div class="row-fluid">
			<div class="span12" style="margin-top: 20px; margin-left: 40px;">
				<table class="table-condensed">
					<tbody>
						<tr>
							<td class="db_settings_label_td table-bordered">
								Chart Name:
							</td>
							<td class="db_settings_input_td table-bordered">
								<input id="embedded_chart_name" name="embedded_chart_name" class="input-large" type="text" placeholder="Enter a chart name..." style="margin-bottom: 0px; height: 25px; font-size: 16px;">
							</td>
							<td></td>
						</tr>
						<tr>
							<td class="db_settings_label_td table-bordered">
								URL:
							</td>
							<td class="db_settings_input_td table-bordered">
								<div class="input-append" style="margin-bottom: 0px;">
									<input id="embedded_chart_url" name="embedded_chart_url" class="input-xxlarge" type="text" placeholder="Chart URL..." style="margin-bottom: 0px; height: 25px; font-size: 16px;">
									<a id="test_embedded_chart" class="btn" style="height: 20px; font-size: 12px; padding-left: 8px; padding-top: 7px; padding-bottom: 6px;">Test</a>
								</div>
							</td>
							<td></td>
						</tr>
						<tr>
							<td colspan="3" align="center">
								<div class="span12" style="margin: auto;">
									<div id="embedded_chart_preview_base" class="db_summary_chart table-bordered" style="height: 250px; margin-left: 10px; margin-right: 5px;"></div>
									<div id="embedded_chart_preview" style="height: 250px; margin-left: 10px; margin-right: 5px; display: none;"></div>
								</div>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span1"></div>
			<div class="span2 controls" style="margin-top: 12px;">
				<input id="embedded_submit" type="submit" name="submit" value="Save" class="btn btn-primary" />
				<a id="clear_embedded_chart_form" class="btn">Clear</a>
			</div>
			<div id="embedded_warning" class="span6 alert alert-error"></div>
			<div class="span3"></div>
		</div>
		#{/form}
	</div>
</div>
<div class="row-fluid" style="margin-top: 30px;">
	<div class="span12">
		<legend>
			Add Script Chart
		</legend>
		<p>
			A Script Chart is a chart that has been manually created and placed in the /public/Charts/HighCharts directory.  Databus currently
			supports the <a href="http://www.highcharts.com" target="_blank">HighCharts</a> charting library.  Other charting 
			libraries will be available with future releases.
		</p>
		#{form @postSaveScriptChartSettings(), id:'savescriptchartsettings'}
		<div class="row-fluid">
			<div class="span12" style="margin-top: 20px; margin-left: 40px;">
				<table class="table-condensed">
					<tbody>
						<tr>
							<td class="db_settings_label_td table-bordered">
								Chart Script:
							</td>
							<td class="db_settings_input_td table-bordered">
								<div class="input-append" style="margin-bottom: 0px;">
									<select id="script_chart_select" name="script_chart_filename" style="margin-bottom: 0px; height: 35px; font-size: 16px; width: 545px;">
										<option></option>
										#{list scriptCharts, as:'chart'}
										<option>${chart.fileName}</option>
										<script type="text/javascript">
											var scriptChart = {};
											scriptChart.fileName = "${chart.fileName}";
											scriptChart.chartName = "${chart.chartName}";
											scriptChart.title = "${chart.title}";
											scriptChart.url = "${chart.url}";
											
											scriptCharts.push(scriptChart);
										</script>
										
										#{/list}
									</select>
									<a id="test_script_chart" class="btn" style="height: 20px; font-size: 12px; padding-left: 8px; padding-top: 7px; padding-bottom: 6px;">Test</a>
								</div>
							</td>
							<td></td>
						</tr>
						<tr>
							<td class="db_settings_label_td table-bordered">
								Chart Name:
							</td>
							<td class="db_settings_input_td table-bordered">
								<input id="script_chart_name" name="script_chart_name"  class="input-xxlarge" type="text" placeholder="Enter a chart name..." style="margin-bottom: 0px; height: 25px; font-size: 16px;">
							</td>
							<td></td>
						</tr>
						<tr>
							<td class="db_settings_label_td table-bordered">
								Chart Title:
							</td>
							<td class="db_settings_input_td table-bordered">
								<input id="script_chart_title" name="script_chart_title" class="input-xxlarge" type="text" placeholder="Enter a chart title..." style="margin-bottom: 0px; height: 25px; font-size: 16px;">
							</td>
							<td></td>
						</tr>
						<tr>
							<td class="db_settings_label_td table-bordered">
								Chart DB:
							</td>
							<td class="db_settings_input_td table-bordered">
								<input id="script_chart_db" name="script_chart_db" class="input-xxlarge" type="text" placeholder="Enter a DB URL..." style="margin-bottom: 0px; height: 25px; font-size: 16px;">
							</td>
							<td></td>
						</tr>
						<tr>
							<td colspan="3" align="center">
								<div class="span12" style="margin: auto;">
									<div id="script_chart_preview_base" class="db_summary_chart table-bordered" style="height: 250px; margin-left: 10px; margin-right: 5px;"></div>
									<div id="script_chart_preview" style="height: 250px; margin-left: 10px; margin-right: 5px; display: none;"></div>
								</div>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span1"></div>
			<div class="span2 controls" style="margin-top: 12px;">
				<input id="script_submit" type="submit" name="submit" value="Save" class="btn btn-primary" />
				<a id="clear_script_chart_form" class="btn">Clear</a>
			</div>
			<div id="script_warning" class="span6 alert alert-error"></div>
			<div class="span3"></div>
		</div>
		#{/form}
	</div>
</div>

<script type="text/javascript">
	$(document).ready(function() {
		/**
		 * Clear everything first...
		 */
		clearEmbeddedForm();
		clearScriptForm();
		
		/**
		 * Remove form enter key submit
		 */
		$('saveaddchartsettings input').keydown(function(event){
			if(event.keyCode == 13) {
				event.preventDefault();
				return false;
			}
		});
		
		$('savescriptchartsettings input').keydown(function(event){
			if(event.keyCode == 13) {
				event.preventDefault();
				return false;
			}
		});
  
		/**
		 * Now show our fake chart
		 */
		showBlankChart('embedded_chart_preview_base');
		showBlankChart('script_chart_preview_base');
	});
	
	$('#embedded_submit').on('click', function (e) {
		if($('#embedded_chart_name').val() === "") {
			$('#embedded_warning').show();
			$('#embedded_warning').html("The chart must have a name before it can be saved.");
			e.preventDefault();
			return;	
		}
		if($('#embedded_chart_url').val() === "") {
			$('#embedded_warning').show();
			$('#embedded_warning').html("The chart must have a url before it can be saved.");
			e.preventDefault();
			return;	
		}
	});
	
	$('#test_embedded_chart').on('click', function (e) {
		$('#embedded_warning').html("");
		$('#embedded_warning').hide();
		
		if($('#embedded_chart_url').val() != "") {
			$('#embedded_chart_preview').show();
			$('#embedded_chart_preview_base').hide();
			var embeddedChartURL = $('#embedded_chart_url').val() + "?divname=embedded_chart_preview&height=250";
			embeddedChartURL = embeddedChartURL.replace("/charts/chart/", "/charts/jschart/"); 
			
			$.get(embeddedChartURL, function(embeddedChartRawData) {
				var embeddedChartData = new Function (embeddedChartRawData);
				embeddedChartData();
			});
		}
    	});
	
	$('#clear_embedded_chart_form').on('click', function (e) {
		clearEmbeddedForm();
    	});
    	
    	$('#clear_script_chart_form').on('click', function (e) {
		clearScriptForm();
    	});
    	
    	function clearEmbeddedForm() {
    		$('#embedded_chart_name').val("");
		$('#embedded_chart_url').val("");
		
		$('#embedded_warning').html("");
		$('#embedded_warning').hide();
		$('#embedded_chart_preview').hide();
		$('#embedded_chart_preview').html("");
		$('#embedded_chart_preview_base').show();
    	}
    	
    	function clearScriptForm() {
    		$('#script_chart_name').val("");
    		$('#script_chart_title').val("");
		$('#script_chart_db').val("");
		$('#script_chart_name').prop('disabled', true);
    		$('#script_chart_title').prop('disabled', true);
		$('#script_chart_db').prop('disabled', true);
		
		$("#script_chart_select").prop("selectedIndex",0);
		$('#script_warning').html("");
		$('#script_warning').hide();
		$('#script_chart_preview').hide();
		$('#script_chart_preview').html("");
		$('#script_chart_preview_base').show();
    	}
    	
    	$('#script_chart_select').change(function() {
		$('#script_chart_name').prop('disabled', false);
    		$('#script_chart_title').prop('disabled', false);
		$('#script_chart_db').prop('disabled', false);
			
		var selectedIndex = $("#script_chart_select").prop("selectedIndex");
		
		if(selectedIndex == 0) {
			clearScriptForm();
			return;
		}
		
		var scriptChart = scriptCharts[(selectedIndex - 1)];
				
		$('#script_chart_name').val(scriptChart.chartName);
    		$('#script_chart_title').val(scriptChart.title);
		$('#script_chart_db').val(scriptChart.url);			
	});
	
	$('#script_submit').on('click', function (e) {
		var selectedIndex = $("#script_chart_select").prop("selectedIndex");
		
		if(selectedIndex == 0) {
			$('#script_warning').show();
			$('#script_warning').html("You must select a chart from the charts list.  If there are no charts listed " +
								 "ask your Databus Administrator to add some HighChart charts.");
			e.preventDefault();
			return;	
		}
		
		var scriptChart = scriptCharts[(selectedIndex - 1)];
		
		var override_title = $('#script_chart_title').val();
		if(override_title === scriptChart.title) {
			$('#script_chart_title').val("");
		}
		
		var override_db = $('#script_chart_db').val();
		if(override_db === scriptChart.url) {
			$('#script_chart_db').val("");
		}
	});
	
	$('#test_script_chart').on('click', function (e) {
		$('#script_warning').html("");
		$('#script_warning').hide();
		
		var selectedIndex = $("#script_chart_select").prop("selectedIndex");
		
		if(selectedIndex == 0) {
			clearScriptForm();
			return;
		}
		
		$('#script_chart_preview').html("");
		
		var scriptChart = scriptCharts[(selectedIndex - 1)];
		
		$('#script_chart_preview').show();
		$('#script_chart_preview_base').hide();
		
		var scriptChartURL = "@{gui.MyCharts.loadChartDiv()}?chart=" + scriptChart.fileName + "&div=script_chart_preview";
		
		var override_name = $('#script_chart_name').val();
		if(override_name != scriptChart.chartName) {
			scriptChartURL += "&override_name=" + fixedEncodeURIComponent(override_name);
		}
		
		var override_title = $('#script_chart_title').val();
		if(override_title != scriptChart.title) {
			scriptChartURL += "&override_title=" + fixedEncodeURIComponent(override_title);
		}
		
		var override_db = $('#script_chart_db').val();
		if(override_db != scriptChart.url) {
			scriptChartURL += "&override_db=" + fixedEncodeURIComponent(override_db);
		}
		
		$.get(scriptChartURL, function(scriptChartRawData) {
			var scriptChartData = new Function (scriptChartRawData);
			scriptChartData();
		});
    	});

	function showBlankChart(divArea) {
		$(function () {
			var chartTitle = "Preview";
			
			var blankChart_alphabetLabel = ['', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z'];
	
			var blankChart_xAxisLabels = {
			    categories: ['','Add', 'a', 'chart', 'to', 'your', 'dashboard', ''],
			    labels:{
			                step: 1
			            },
			    text: null
			};
			
			var blankChartSeriesData = [{
			                    showInLegend: false,
			                    data: [0,1,1,3,20,25,4,0]
			                    }];
			
			var blankChart = new Highcharts.Chart({
			    title: {
			        text: chartTitle
			    },
			    chart: {
			        renderTo: divArea,
        			   borderColor: '#dddddd',
        			   borderWidth: 1
			    },
			
			    xAxis: blankChart_xAxisLabels,
			    yAxis: {
			            endOnTick: false,
			            min: 0,
			            max: 26,
			            tickInterval: 2,
			            title: { text: 'Alphabet' },
			            labels: {
			                        formatter: function() {
			                            return blankChart_alphabetLabel[this.value];
			                        }
			                    }  
			            },
			
			    series: blankChartSeriesData
			
			});
		});
	}
	
	function fixedEncodeURIComponent (str) {
	  return encodeURIComponent(str).replace(/[!'()]/g, escape).replace(/\*/g, "%2A");
	}
</script>

<!-- FOR DEBUG -->
<!--</body></html>-->
<!-- ********* -->